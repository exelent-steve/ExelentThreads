# ExelentThreads - CSV Workflow MVP - Technical Specification

**Version:** 1.0
**Last Updated:** 2025-11-05
**Phase:** 1 - CSV Workflow (No integrated AI chat)

---

## Table of Contents

1. [Project Overview](#1-project-overview)
2. [CSV File Format Specification](#2-csv-file-format-specification)
3. [Database Schema](#3-database-schema)
4. [Data Flow & Sync Logic](#4-data-flow--sync-logic)
5. [UI Components & Layout](#5-ui-components--layout)
6. [Views & Features](#6-views--features)
7. [Technical Architecture](#7-technical-architecture)
8. [Implementation Details](#8-implementation-details)
9. [Error Handling & Validation](#9-error-handling--validation)
10. [Settings & Configuration](#10-settings--configuration)

---

## 1. Project Overview

### 1.1 Purpose
ExelentThreads is a CSV-based topic management application that bridges manual Claude Code workflows with a beautiful UI. Users import CSV files containing topics/issues, view and edit them in multiple visual formats, then export back to CSV for Claude Code to process.

### 1.2 Phase 1 Scope (CSV Workflow)
- Import CSV files with topics
- Display topics in 5 views: Conversation, Table, Board, Timeline, Analytics
- Edit topics and comments in app
- Export to CSV with automatic backups
- Multi-project support (one CSV per project)
- File watching for automatic import notifications
- Search and filter functionality

### 1.3 Phase 2 (Future - NOT in this spec)
- Integrated AI chat with topic extraction
- Real-time AI responses
- Document/artifact management

**CRITICAL:** This spec is ONLY for Phase 1. Do NOT implement Phase 2 features.

---

## 2. CSV File Format Specification

### 2.1 Template File
Reference: `/Planning/csv-workflow-questions.csv`

### 2.2 Column Structure

#### Fixed Columns (A-H) - ALWAYS in this order in export:
1. **ID** - UUID format: `topic_abc123def456` (generated by app)
2. **Topic** - String, max 200 chars (the title)
3. **Description** - String, unlimited length
4. **Status** - Enum: `Open`, `In Progress`, `Resolved`, `Closed`
5. **Priority** - Enum: `High`, `Medium`, `Low`
6. **Category** - String (e.g., Technical, UX, Database, Backend, Frontend, Planning)
7. **Date_Created** - ISO format: `YYYY-MM-DD` or `DD/MM/YYYY` (parser accepts both)
8. **Date_Updated** - ISO format: `YYYY-MM-DD` or `DD/MM/YYYY` (auto-updated by app)

#### Expandable Comment Columns (I onwards):
9. **Your_Comments** - User's first comment (optional)
10. **Claude_Comments** - AI's first response (optional)
11. **Your_Comments_2** - User's second comment (optional)
12. **Claude_Comments_2** - AI's second response (optional)
13. ... continues as needed (Your_Comments_3, Claude_Comments_3, etc.)

### 2.3 Special Rows

#### Row 1: Header Row
Contains column names. Parser uses these to identify columns (position-independent).

#### Row 2: Instructions Row (INST)
- **ID**: `INST`
- **Topic**: `[INSTRUCTIONS FOR CLAUDE]`
- **Description**: Instructions text for AI
- All other columns: empty
- Parser skips this row for data but includes in export
- Template content:
```
CRITICAL RULES FOR AI: (1) NEVER overwrite existing comment columns - ALWAYS add a NEW column to the right. (2) Name new columns sequentially: Your_Comments, Claude_Comments, Your_Comments_2, Claude_Comments_2, etc. (3) Prefix each comment with timestamp: 'YYYY-MM-DD HH:MM: ' (4) Update Date_Updated column (Column H) to current date when modifying any row. (5) Update Status column (Column D) to Resolved when answering. (6) Fixed columns A-H are: ID, Topic, Description, Status, Priority, Category, Date_Created, Date_Updated. (7) Parser identifies columns by NAME not position - column order can vary. (8) ID column uses UUIDs (format: topic_abc123). (9) This CSV file is the TEMPLATE - use exact structure when creating exports.
```

### 2.4 Comment Timestamp Format
Each comment MUST start with: `YYYY-MM-DD HH:MM: `

Example:
```
2025-11-05 14:35: This is my comment about the topic.
```

Parser extracts timestamp for database storage. If missing, uses file modification time.

### 2.5 CSV Parsing Rules

#### Column Detection:
1. Read header row (row 1)
2. Create map: `columnName â†’ columnIndex`
3. For each data row, access values by column name, NOT position
4. Column order can vary - parser is flexible

#### Required Columns (validation):
- ID
- Topic
- Description
- Status

If any required column missing â†’ show error:
```
Missing required column: [name]
Found columns: [list of actual column names]
```

#### Optional Columns:
- Priority (default: Medium if missing)
- Category (default: Uncategorized if missing)
- Date_Created (default: current date if missing)
- Date_Updated (default: current date if missing)
- All comment columns (empty if missing)

#### Row Filtering:
- Skip row if ID = "INST" (instructions row)
- Skip row if ID is empty/null
- Skip completely empty rows

---

## 3. Database Schema

### 3.1 Technology
- **Development:** SQLite (local file: `exelentthreads.db`)
- **Optional:** Turso (SQLite-compatible, cloud sync for future)
- **ORM:** Drizzle ORM (type-safe queries)

### 3.2 Tables

#### 3.2.1 Projects Table
```sql
CREATE TABLE projects (
  id TEXT PRIMARY KEY,              -- UUID format: project_abc123
  name TEXT NOT NULL,               -- User-friendly name
  csv_file_path TEXT NOT NULL,     -- Absolute path to CSV file
  color TEXT DEFAULT '#2563eb',    -- Hex color for UI
  last_opened TIMESTAMP,            -- Last time project was opened
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `last_opened` (for sorting recent projects)

#### 3.2.2 Topics Table
```sql
CREATE TABLE topics (
  id TEXT PRIMARY KEY,              -- UUID from CSV (topic_abc123)
  project_id TEXT NOT NULL,         -- FK to projects.id
  topic TEXT NOT NULL,              -- Column B from CSV
  description TEXT,                 -- Column C from CSV
  status TEXT NOT NULL DEFAULT 'Open',  -- Column D: Open|In Progress|Resolved|Closed
  priority TEXT DEFAULT 'Medium',   -- Column E: High|Medium|Low
  category TEXT DEFAULT 'Uncategorized', -- Column F
  date_created TEXT NOT NULL,       -- Column G: YYYY-MM-DD
  date_updated TEXT NOT NULL,       -- Column H: YYYY-MM-DD
  is_locked BOOLEAN DEFAULT 0,      -- 1 if Topic/Description locked after first export
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);
```

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `project_id` (for filtering by project)
- INDEX on `status` (for filtering)
- INDEX on `priority` (for filtering)
- INDEX on `category` (for filtering)
- INDEX on `date_updated` (for sorting)

**Constraints:**
- `status` CHECK: IN ('Open', 'In Progress', 'Resolved', 'Closed')
- `priority` CHECK: IN ('High', 'Medium', 'Low')

#### 3.2.3 Comments Table
```sql
CREATE TABLE comments (
  id TEXT PRIMARY KEY,              -- UUID: comment_abc123
  topic_id TEXT NOT NULL,           -- FK to topics.id
  author TEXT NOT NULL,             -- 'user' or 'claude'
  content TEXT NOT NULL,            -- Comment text (without timestamp prefix)
  comment_round INTEGER NOT NULL,   -- 1, 2, 3, etc. (which round of comments)
  created_at TIMESTAMP NOT NULL,    -- Extracted from comment prefix or file mod time
  FOREIGN KEY (topic_id) REFERENCES topics(id) ON DELETE CASCADE
);
```

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `topic_id` (for fetching comments per topic)
- INDEX on `created_at` (for chronological ordering)

**Composite Index:**
- INDEX on (`topic_id`, `comment_round`, `author`) for efficient comment retrieval

#### 3.2.4 Categories Table (for dropdown management)
```sql
CREATE TABLE categories (
  id TEXT PRIMARY KEY,              -- UUID: category_abc123
  project_id TEXT NOT NULL,         -- FK to projects.id
  name TEXT NOT NULL,               -- Category name
  is_suggested BOOLEAN DEFAULT 0,   -- 1 if from instructions template
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  UNIQUE(project_id, name)          -- No duplicate categories per project
);
```

**Indexes:**
- PRIMARY KEY on `id`
- UNIQUE INDEX on (`project_id`, `name`)

**Default Categories (seeded when project created):**
- Technical
- UX
- Database
- Backend
- Frontend
- Planning

---

## 4. Data Flow & Sync Logic

### 4.1 Import Flow (CSV â†’ Database)

```
User clicks "Import CSV" OR app detects file change
  â†“
1. Read CSV file
2. Parse header row â†’ create columnName â†’ columnIndex map
3. Validate required columns exist (ID, Topic, Description, Status)
   - If missing â†’ show error modal, abort
4. For each data row:
   a. Skip if ID = "INST" or ID is empty
   b. Extract values using column names
   c. Check if topic ID exists in database:
      - IF EXISTS â†’ UPDATE existing topic record
      - IF NOT EXISTS â†’ INSERT new topic record
   d. Generate UUID if ID column is empty
   e. Parse comment columns (Your_Comments, Claude_Comments, etc.)
   f. For each comment:
      - Extract timestamp from "YYYY-MM-DD HH:MM: " prefix
      - Determine author: "Your_Comments" â†’ user, "Claude_Comments" â†’ claude
      - Determine round: _2 suffix â†’ round 2, etc.
      - INSERT into comments table (or UPDATE if exists)
   g. Extract categories â†’ INSERT into categories table if not exists
5. Show success toast: "Imported X topics, Y comments"
```

### 4.2 Export Flow (Database â†’ CSV)

```
User clicks "Export CSV" OR "New Topic" auto-exports
  â†“
1. Backup existing CSV file:
   - Create .backups/ folder if not exists
   - Copy CSV to: filename_backup_YYYYMMDD_HHMM.csv
   - Cleanup old backups (keep last 10, configurable)
2. Query database for current project:
   - Fetch all topics for project_id (ordered by date_updated DESC)
   - For each topic, fetch all comments (ordered by comment_round, author)
3. Build CSV structure:
   - Row 1: Header (Fixed columns A-H + comment columns)
   - Row 2: Instructions row (ID=INST)
   - Row 3+: Topic data
4. Determine max comment rounds across all topics
   - Add columns: Your_Comments, Claude_Comments, Your_Comments_2, Claude_Comments_2, ..., Your_Comments_N, Claude_Comments_N
5. For each topic row:
   - Fill fixed columns A-H with topic data
   - For each comment:
     - Determine column: author + round â†’ Your_Comments_2, etc.
     - Format: "YYYY-MM-DD HH:MM: " + content
6. Write CSV file (overwrite original path)
7. Show success toast: "Exported to [filename].csv (backup created)"
```

### 4.3 UUID Generation

**Format:** `{type}_{randomString}`
- Topics: `topic_abc123def456`
- Comments: `comment_xyz789ghi012`
- Projects: `project_mno345pqr678`
- Categories: `category_stu901vwx234`

**Random String:** 12 characters, alphanumeric lowercase

**Library:** Use `nanoid` or `crypto.randomUUID()` then format

### 4.4 File Watching Logic

```
On app initialization OR project switch:
  â†“
1. Get CSV file path from project record
2. Start file watcher (fs.watch or chokidar library)
3. Watch for: file modification events
4. On file modified:
   a. Debounce 500ms (avoid multiple triggers)
   b. Read file modification time
   c. Compare with last_imported_time (stored in memory)
   d. If newer:
      - Show toast notification: "CSV file updated. Click to import."
      - Show "Import" button in toast
5. User clicks "Import" â†’ trigger import flow
6. Update last_imported_time = file modification time
```

**Settings:**
- Auto-check interval: 10s / 30s / 60s / Off (default: 30s)
- Manual refresh button always available
- Disable file watching: checkbox in settings

---

## 5. UI Components & Layout

### 5.1 Overall Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header: Logo | Search Bar | Actions (Import, Export, +New) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚                                                   â”‚
â”‚ Sidebar  â”‚            Main Content Area                     â”‚
â”‚          â”‚          (Active View Renders Here)              â”‚
â”‚ - Logo   â”‚                                                   â”‚
â”‚ - Proj   â”‚  Views:                                          â”‚
â”‚   List   â”‚  â€¢ Conversation (default)                        â”‚
â”‚ - Nav:   â”‚  â€¢ Table                                         â”‚
â”‚   Conv   â”‚  â€¢ Board                                         â”‚
â”‚   Table  â”‚  â€¢ Timeline                                      â”‚
â”‚   Board  â”‚  â€¢ Analytics                                     â”‚
â”‚   Time   â”‚                                                   â”‚
â”‚   Analy  â”‚                                                   â”‚
â”‚ - Footer â”‚                                                   â”‚
â”‚   Help   â”‚                                                   â”‚
â”‚   Sett   â”‚                                                   â”‚
â”‚          â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Color Scheme (from current mockup)

```css
--bg-primary: #0f172a (dark blue-gray)
--bg-secondary: #1e293b (lighter blue-gray)
--bg-tertiary: #334155 (card backgrounds)
--text-primary: #f1f5f9 (white-ish)
--text-secondary: #94a3b8 (gray)
--border-color: #334155
--primary-blue: #2563eb
--primary-blue-hover: #1d4ed8
```

**Status Colors:**
- Open: `#3b82f6` (blue)
- In Progress: `#eab308` (yellow)
- Resolved: `#22c55e` (green)
- Closed: `#6b7280` (gray)

**Priority Colors:**
- High: `#ef4444` (red)
- Medium: `#f97316` (orange)
- Low: `#6b7280` (gray)

### 5.3 Sidebar Component

**Structure:**
```html
<aside class="sidebar">
  <!-- Logo -->
  <div class="sidebar-header">
    <a href="/" class="sidebar-logo">
      <span>ğŸ§µ ExelentThreads</span>
    </a>
  </div>

  <!-- Project Selector -->
  <div class="sidebar-project-selector">
    <label>Current Project</label>
    <div class="project-dropdown">
      <button id="project-selector-btn">
        <span class="project-color-dot" style="background: {project.color}"></span>
        <span>{project.name}</span>
        <span>â–¼</span>
      </button>
      <div class="project-dropdown-menu hidden">
        <!-- Projects list -->
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="sidebar-nav">
    <div class="sidebar-section-title">Views</div>
    <button class="sidebar-nav-item active" data-view="conversation">
      <span>ğŸ’¬</span> Conversation
    </button>
    <button class="sidebar-nav-item" data-view="table">
      <span>ğŸ“Š</span> Table
    </button>
    <button class="sidebar-nav-item" data-view="board">
      <span>ğŸ“‹</span> Board
    </button>
    <button class="sidebar-nav-item" data-view="timeline">
      <span>ğŸ“…</span> Timeline
    </button>
    <button class="sidebar-nav-item" data-view="analytics">
      <span>ğŸ“ˆ</span> Analytics
    </button>
  </nav>

  <!-- Footer Actions -->
  <div class="sidebar-footer">
    <button id="manage-projects-btn">
      <span>ğŸ“</span> Manage Projects
    </button>
    <button id="help-btn">
      <span>â“</span> Help
    </button>
    <button id="settings-btn">
      <span>âš™ï¸</span> Settings
    </button>
  </div>
</aside>
```

**Functionality:**
- Active view highlighted with `.active` class
- Project dropdown shows all projects with color dots
- Click project â†’ switch to that project (reload topics from DB)
- Manage Projects â†’ modal to add/remove/edit projects

### 5.4 Header Component

```html
<header class="content-header">
  <!-- Search Bar -->
  <div class="search-container">
    <input type="text" id="global-search" placeholder="ğŸ” Search topics..." />
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <button id="import-csv-btn" class="action-btn">
      <span>â†‘</span> Import CSV
    </button>
    <button id="export-csv-btn" class="action-btn">
      <span>â†“</span> Export CSV
    </button>
    <button id="new-topic-btn" class="action-btn action-btn-primary">
      <span>+</span> New Topic
    </button>
  </div>
</header>
```

**Functionality:**
- Global search: real-time fuzzy search across Topic, Description, all comment columns
- Import CSV: opens file picker, triggers import flow
- Export CSV: triggers export flow
- New Topic: opens modal with form

---

## 6. Views & Features

### 6.1 Conversation View (Default)

**Layout:**
Reference: `index.html` conversation view

**Structure:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Filters: [Status â–¼] [Priority â–¼] [Category â–¼]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  Topic Card 1                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”— [Related Topics: Topic 5, Topic 12]         â”‚ â”‚
â”‚  â”‚                                                 â”‚ â”‚
â”‚  â”‚ **API Authentication Strategy**    [Resolved]  â”‚ â”‚
â”‚  â”‚ Need to decide between JWT and session-based   â”‚ â”‚
â”‚  â”‚                                                 â”‚ â”‚
â”‚  â”‚ ğŸ’¬ 3 exchanges | ğŸ“ Security | â¬†ï¸ High          â”‚ â”‚
â”‚  â”‚                                                 â”‚ â”‚
â”‚  â”‚ Latest: "2025-11-04: Decided on JWT..."        â”‚ â”‚
â”‚  â”‚ [View Details]                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                      â”‚
â”‚  Topic Card 2                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ **Database Choice**                [Open]       â”‚ â”‚
â”‚  â”‚ PostgreSQL vs MySQL for main database          â”‚ â”‚
â”‚  â”‚                                                 â”‚ â”‚
â”‚  â”‚ ğŸ’¬ 2 exchanges | ğŸ“ Database | â†’ Medium         â”‚ â”‚
â”‚  â”‚                                                 â”‚ â”‚
â”‚  â”‚ Latest: "2025-11-03: Considering Postgres..."  â”‚ â”‚
â”‚  â”‚ [View Details]                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
- Topic cards sorted by `date_updated` DESC (newest first)
- Show latest comment preview (truncated to 100 chars)
- Click card OR "View Details" â†’ open Topic Detail Modal
- Filter dropdowns update display in real-time
- Related topics shown as blue bar at top of card (if any)

**Topic Card Component:**
```html
<div class="topic-card" data-topic-id="{topic.id}">
  <!-- Related Topics (if any) -->
  {#if topic.relatedTopics.length > 0}
  <div class="topic-related-bar">
    ğŸ”— Related:
    {#each topic.relatedTopics as related}
      <a href="#" class="related-topic-link">{related.topic}</a>
    {/each}
  </div>
  {/if}

  <!-- Header -->
  <div class="topic-card-header">
    <h3 class="topic-card-title">{topic.topic}</h3>
    <span class="topic-card-status status-{topic.status.toLowerCase()}">
      {topic.status}
    </span>
  </div>

  <!-- Description -->
  <p class="topic-card-description">{topic.description}</p>

  <!-- Meta Info -->
  <div class="topic-card-meta">
    <span>ğŸ’¬ {topic.commentCount} exchanges</span>
    <span>ğŸ“ {topic.category}</span>
    <span class="priority-{topic.priority.toLowerCase()}">
      {#if topic.priority === 'High'}â¬†ï¸{:else if topic.priority === 'Medium'}â†’{:else}â†“{/if}
      {topic.priority}
    </span>
  </div>

  <!-- Latest Comment -->
  <div class="topic-card-latest">
    <strong>Latest:</strong> {topic.latestComment}
  </div>

  <!-- Actions -->
  <button class="btn-view-details">View Details</button>
</div>
```

### 6.2 Table View

**Layout:**
Standard HTML table with sortable columns

```
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID â”‚ Topic              â”‚ Status    â”‚ Priorityâ”‚ Category â”‚ Updated â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ API Auth Strategy  â”‚ Resolved  â”‚ High    â”‚ Security â”‚ Nov 4   â”‚
â”‚ 2  â”‚ Database Choice    â”‚ Open      â”‚ Medium  â”‚ Database â”‚ Nov 3   â”‚
â”‚ 3  â”‚ Error Handling     â”‚ In Prog   â”‚ High    â”‚ Backend  â”‚ Nov 5   â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
- Click column header â†’ sort ascending/descending
- Click row â†’ open Topic Detail Modal
- Inline edit for Status (dropdown), Priority (dropdown), Category (dropdown)
- Responsive: stack on mobile

**Implementation:**
```html
<table class="topics-table">
  <thead>
    <tr>
      <th data-sort="id">ID <span class="sort-icon">â†•</span></th>
      <th data-sort="topic">Topic <span class="sort-icon">â†•</span></th>
      <th data-sort="status">Status <span class="sort-icon">â†•</span></th>
      <th data-sort="priority">Priority <span class="sort-icon">â†•</span></th>
      <th data-sort="category">Category <span class="sort-icon">â†•</span></th>
      <th data-sort="date_updated">Updated <span class="sort-icon">â†•</span></th>
    </tr>
  </thead>
  <tbody>
    {#each topics as topic}
    <tr data-topic-id="{topic.id}">
      <td>{topic.id.split('_')[1].substring(0, 6)}</td>
      <td class="topic-title">{topic.topic}</td>
      <td>
        <select class="status-select" value="{topic.status}">
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
          <option value="Closed">Closed</option>
        </select>
      </td>
      <td>
        <select class="priority-select" value="{topic.priority}">
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </td>
      <td>
        <input type="text" class="category-input" value="{topic.category}" />
      </td>
      <td>{formatDate(topic.date_updated)}</td>
    </tr>
    {/each}
  </tbody>
</table>
```

### 6.3 Board View (Kanban)

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Open        â”‚ In Progress  â”‚ Resolved     â”‚ Closed       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Topic 1  â”‚ â”‚ â”‚ Topic 3  â”‚ â”‚ â”‚ Topic 2  â”‚ â”‚ â”‚ Topic 5  â”‚ â”‚
â”‚ â”‚ High     â”‚ â”‚ â”‚ High     â”‚ â”‚ â”‚ Med      â”‚ â”‚ â”‚ Low      â”‚ â”‚
â”‚ â”‚ Security â”‚ â”‚ â”‚ Backend  â”‚ â”‚ â”‚ Database â”‚ â”‚ â”‚ UX       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚              â”‚              â”‚              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚ â”‚ Topic 4  â”‚ â”‚              â”‚ â”‚ Topic 6  â”‚ â”‚              â”‚
â”‚ â”‚ Low      â”‚ â”‚              â”‚ â”‚ High     â”‚ â”‚              â”‚
â”‚ â”‚ Frontend â”‚ â”‚              â”‚ â”‚ Planning â”‚ â”‚              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
- Drag & drop to change status
- Cards show: Topic, Priority indicator, Category
- Click card â†’ open Topic Detail Modal
- Column counts: "Open (5)"

**Implementation:**
- Use drag-and-drop library (e.g., `@dnd-kit/core` or `react-beautiful-dnd`)
- On drop: update topic status in DB, trigger re-render

### 6.4 Timeline View (Cascading Waterfall)

**Layout:**
```
Nov 5, 2025  â”€â”¬â”€ [Topic 3: Error Handling] In Progress | High | Backend
              â”‚
Nov 4, 2025  â”€â”¼â”€ [Topic 1: API Auth] Resolved | High | Security
              â”‚
Nov 3, 2025  â”€â”¼â”€ [Topic 2: Database] Open | Medium | Database
              â”‚   [Topic 4: UI Components] Open | Low | Frontend
              â”‚
Nov 2, 2025  â”€â”´â”€ [Topic 6: Deployment] Closed | Med | DevOps
```

**Features:**
- Topics grouped by `date_updated`
- Cascading layout (waterfall style)
- Color-coded by status
- Click topic â†’ open Topic Detail Modal

**Implementation:**
```jsx
{Object.entries(groupByDate(topics)).map(([date, topicsOnDate]) => (
  <div class="timeline-date-group">
    <div class="timeline-date">{formatDate(date)}</div>
    <div class="timeline-topics">
      {topicsOnDate.map(topic => (
        <div class="timeline-topic-card status-{topic.status.toLowerCase()}">
          <span class="timeline-topic-title">{topic.topic}</span>
          <span class="timeline-topic-status">{topic.status}</span>
          <span class="timeline-topic-meta">
            {topic.priority} | {topic.category}
          </span>
        </div>
      ))}
    </div>
  </div>
))}
```

### 6.5 Analytics View

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Analytics Dashboard                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ Total    â”‚ Open     â”‚ Resolved â”‚ Closed   â”‚          â”‚
â”‚ â”‚ 45       â”‚ 12       â”‚ 28       â”‚ 5        â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ Topics by Status (Pie Chart)              â”‚           â”‚
â”‚ â”‚                                            â”‚           â”‚
â”‚ â”‚     [Pie Chart Visualization]             â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ Topics by Category (Bar Chart)            â”‚           â”‚
â”‚ â”‚                                            â”‚           â”‚
â”‚ â”‚ Technical   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 15               â”‚           â”‚
â”‚ â”‚ UX          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 10                    â”‚           â”‚
â”‚ â”‚ Database    â–ˆâ–ˆâ–ˆâ–ˆ 6                        â”‚           â”‚
â”‚ â”‚ Backend     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 12                  â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ Activity Over Time (Line Chart)           â”‚           â”‚
â”‚ â”‚                                            â”‚           â”‚
â”‚ â”‚     [Line Chart: Topics created/updated]  â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
- Summary stats: Total, Open, Resolved, Closed counts
- Pie chart: Topics by Status
- Bar chart: Topics by Category
- Line chart: Activity over time (topics created/updated per day/week)
- Average response time (time between Your_Comments and Claude_Comments)

**Charting Library:**
Use `recharts` (React) or `chart.js` (vanilla JS)

**Data Queries:**
```javascript
// Summary stats
const stats = {
  total: await db.select({ count: sql`COUNT(*)` }).from(topics).where(eq(topics.project_id, currentProjectId)),
  open: await db.select({ count: sql`COUNT(*)` }).from(topics).where(and(eq(topics.project_id, currentProjectId), eq(topics.status, 'Open'))),
  resolved: await db.select({ count: sql`COUNT(*)` }).from(topics).where(and(eq(topics.project_id, currentProjectId), eq(topics.status, 'Resolved'))),
  closed: await db.select({ count: sql`COUNT(*)` }).from(topics).where(and(eq(topics.project_id, currentProjectId), eq(topics.status, 'Closed')))
};

// Topics by category
const byCategory = await db.select({
  category: topics.category,
  count: sql`COUNT(*)`
}).from(topics).where(eq(topics.project_id, currentProjectId)).groupBy(topics.category);
```

---

## 7. Technical Architecture

### 7.1 Technology Stack

**Framework:** Next.js 14 (App Router)
- TypeScript for type safety
- Server actions for DB operations
- Client components for interactivity

**Database:** SQLite + Drizzle ORM
- Local development: `exelentthreads.db` file
- Optional: Turso for cloud sync (future)

**UI Library:** Tailwind CSS
- Shadcn/ui components (optional, for modals/dropdowns)
- Custom CSS matching current mockup colors

**File Watching:** `chokidar` library
- Cross-platform file system watching
- Debounced events

**CSV Parsing:** `papaparse` library
- Header detection
- Flexible column ordering
- Handles quoted fields, escaped commas

**UUID Generation:** `nanoid` library

**Charts:** `recharts` library (React charts)

### 7.2 File Structure

```
exelentthreads/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx                 # Root layout with sidebar
â”‚   â”œâ”€â”€ page.tsx                   # Home page â†’ redirect to /projects
â”‚   â”œâ”€â”€ projects/
â”‚   â”‚   â”œâ”€â”€ [id]/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx           # Project view (renders active view)
â”‚   â”‚   â”‚   â”œâ”€â”€ conversation/      # Conversation view component
â”‚   â”‚   â”‚   â”œâ”€â”€ table/             # Table view component
â”‚   â”‚   â”‚   â”œâ”€â”€ board/             # Board view component
â”‚   â”‚   â”‚   â”œâ”€â”€ timeline/          # Timeline view component
â”‚   â”‚   â”‚   â””â”€â”€ analytics/         # Analytics view component
â”‚   â”‚   â””â”€â”€ new/
â”‚   â”‚       â””â”€â”€ page.tsx           # New project creation
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ import/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts           # Import CSV endpoint
â”‚   â”‚   â”œâ”€â”€ export/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts           # Export CSV endpoint
â”‚   â”‚   â””â”€â”€ topics/
â”‚   â”‚       â”œâ”€â”€ route.ts           # CRUD topics
â”‚   â”‚       â””â”€â”€ [id]/
â”‚   â”‚           â””â”€â”€ route.ts       # Single topic operations
â”‚   â””â”€â”€ globals.css                # Tailwind + custom CSS
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ sidebar.tsx                # Left sidebar
â”‚   â”œâ”€â”€ header.tsx                 # Top header
â”‚   â”œâ”€â”€ topic-card.tsx             # Topic card component
â”‚   â”œâ”€â”€ topic-modal.tsx            # Topic detail modal
â”‚   â”œâ”€â”€ modals/
â”‚   â”‚   â”œâ”€â”€ new-topic-modal.tsx    # New topic form
â”‚   â”‚   â”œâ”€â”€ settings-modal.tsx     # Settings
â”‚   â”‚   â””â”€â”€ help-modal.tsx         # Help
â”‚   â””â”€â”€ ui/                        # Reusable UI components (buttons, inputs, etc.)
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ schema.ts              # Drizzle schema definitions
â”‚   â”‚   â”œâ”€â”€ client.ts              # Database client initialization
â”‚   â”‚   â””â”€â”€ migrations/            # Migration files
â”‚   â”œâ”€â”€ csv/
â”‚   â”‚   â”œâ”€â”€ parser.ts              # CSV parsing logic
â”‚   â”‚   â”œâ”€â”€ exporter.ts            # CSV export logic
â”‚   â”‚   â””â”€â”€ validator.ts           # CSV validation
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ uuid.ts                # UUID generation
â”‚   â”‚   â”œâ”€â”€ date.ts                # Date formatting utilities
â”‚   â”‚   â””â”€â”€ search.ts              # Search/filter utilities
â”‚   â””â”€â”€ file-watcher.ts            # File watching logic
â”œâ”€â”€ public/                        # Static assets
â”œâ”€â”€ drizzle.config.ts              # Drizzle ORM config
â”œâ”€â”€ next.config.js                 # Next.js config
â”œâ”€â”€ tailwind.config.js             # Tailwind config
â”œâ”€â”€ tsconfig.json                  # TypeScript config
â””â”€â”€ package.json
```

### 7.3 State Management

**Server State (Database):**
- Drizzle ORM queries
- Server actions for mutations
- React Server Components for data fetching

**Client State:**
- React `useState` for UI state (modals, dropdowns, filters)
- Optional: Zustand for global state (current project, file watcher status)

**No Redux/MobX needed** - Keep it simple with server actions + local state

---

## 8. Implementation Details

### 8.1 CSV Parser (lib/csv/parser.ts)

```typescript
import Papa from 'papaparse';

interface CSVRow {
  [key: string]: string;
}

interface ParsedTopic {
  id: string;
  topic: string;
  description: string;
  status: string;
  priority: string;
  category: string;
  date_created: string;
  date_updated: string;
  comments: Array<{
    author: 'user' | 'claude';
    content: string;
    round: number;
    timestamp: Date;
  }>;
}

export function parseCSV(fileContent: string): {
  topics: ParsedTopic[];
  instructions: string;
  errors: string[];
} {
  const result = Papa.parse<CSVRow>(fileContent, {
    header: true,
    skipEmptyLines: true,
    transformHeader: (header) => header.trim()
  });

  const errors: string[] = [];
  const topics: ParsedTopic[] = [];
  let instructions = '';

  // Validate required columns
  const requiredColumns = ['ID', 'Topic', 'Description', 'Status'];
  const headers = result.meta.fields || [];

  for (const col of requiredColumns) {
    if (!headers.includes(col)) {
      errors.push(`Missing required column: ${col}. Found: ${headers.join(', ')}`);
      return { topics: [], instructions: '', errors };
    }
  }

  // Process rows
  for (const row of result.data) {
    // Extract instructions row
    if (row.ID === 'INST') {
      instructions = row.Description || row.Topic || '';
      continue;
    }

    // Skip empty rows
    if (!row.ID || row.ID.trim() === '') continue;

    // Parse topic
    const topic: ParsedTopic = {
      id: row.ID,
      topic: row.Topic || '',
      description: row.Description || '',
      status: row.Status || 'Open',
      priority: row.Priority || 'Medium',
      category: row.Category || 'Uncategorized',
      date_created: row.Date_Created || new Date().toISOString().split('T')[0],
      date_updated: row.Date_Updated || new Date().toISOString().split('T')[0],
      comments: []
    };

    // Parse comment columns
    const commentColumns = headers.filter(h =>
      h.startsWith('Your_Comments') || h.startsWith('Claude_Comments')
    );

    for (const colName of commentColumns) {
      const content = row[colName];
      if (!content || content.trim() === '') continue;

      // Extract author
      const author: 'user' | 'claude' = colName.startsWith('Your_') ? 'user' : 'claude';

      // Extract round number
      const roundMatch = colName.match(/_(\d+)$/);
      const round = roundMatch ? parseInt(roundMatch[1]) : 1;

      // Extract timestamp from content (format: "YYYY-MM-DD HH:MM: ")
      const timestampRegex = /^(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}):\s+/;
      const match = content.match(timestampRegex);

      let timestamp: Date;
      let cleanContent: string;

      if (match) {
        timestamp = new Date(`${match[1]}T${match[2]}:00`);
        cleanContent = content.replace(timestampRegex, '');
      } else {
        // Fallback: use current time
        timestamp = new Date();
        cleanContent = content;
      }

      topic.comments.push({
        author,
        content: cleanContent,
        round,
        timestamp
      });
    }

    topics.push(topic);
  }

  return { topics, instructions, errors };
}
```

### 8.2 CSV Exporter (lib/csv/exporter.ts)

```typescript
import Papa from 'papaparse';

interface ExportTopic {
  id: string;
  topic: string;
  description: string;
  status: string;
  priority: string;
  category: string;
  date_created: string;
  date_updated: string;
  comments: Array<{
    author: 'user' | 'claude';
    content: string;
    round: number;
    timestamp: Date;
  }>;
}

export function exportCSV(
  topics: ExportTopic[],
  instructions: string
): string {
  // Determine max comment rounds
  let maxRounds = 1;
  for (const topic of topics) {
    for (const comment of topic.comments) {
      if (comment.round > maxRounds) maxRounds = comment.round;
    }
  }

  // Build header row
  const headers = [
    'ID', 'Topic', 'Description', 'Status', 'Priority', 'Category',
    'Date_Created', 'Date_Updated'
  ];

  for (let i = 1; i <= maxRounds; i++) {
    if (i === 1) {
      headers.push('Your_Comments', 'Claude_Comments');
    } else {
      headers.push(`Your_Comments_${i}`, `Claude_Comments_${i}`);
    }
  }

  // Build rows
  const rows: any[] = [];

  // Instructions row
  const instRow: any = {
    ID: 'INST',
    Topic: '[INSTRUCTIONS FOR CLAUDE]',
    Description: instructions
  };
  rows.push(instRow);

  // Topic rows
  for (const topic of topics) {
    const row: any = {
      ID: topic.id,
      Topic: topic.topic,
      Description: topic.description,
      Status: topic.status,
      Priority: topic.priority,
      Category: topic.category,
      Date_Created: topic.date_created,
      Date_Updated: topic.date_updated
    };

    // Add comments
    for (const comment of topic.comments) {
      const colName = comment.round === 1
        ? (comment.author === 'user' ? 'Your_Comments' : 'Claude_Comments')
        : (comment.author === 'user' ? `Your_Comments_${comment.round}` : `Claude_Comments_${comment.round}`);

      const timestamp = comment.timestamp.toISOString().split('T')[0] + ' ' +
                       comment.timestamp.toISOString().split('T')[1].substring(0, 5);

      row[colName] = `${timestamp}: ${comment.content}`;
    }

    rows.push(row);
  }

  // Generate CSV
  const csv = Papa.unparse(rows, {
    columns: headers,
    quotes: true,
    quoteChar: '"',
    escapeChar: '"',
    delimiter: ',',
    header: true,
    newline: '\n'
  });

  return csv;
}
```

### 8.3 Import Handler (app/api/import/route.ts)

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { parseCSV } from '@/lib/csv/parser';
import { db } from '@/lib/db/client';
import { topics, comments, categories } from '@/lib/db/schema';
import { eq, and } from 'drizzle-orm';

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const file = formData.get('file') as File;
    const projectId = formData.get('projectId') as string;

    if (!file || !projectId) {
      return NextResponse.json({ error: 'Missing file or projectId' }, { status: 400 });
    }

    const fileContent = await file.text();
    const { topics: parsedTopics, instructions, errors } = parseCSV(fileContent);

    if (errors.length > 0) {
      return NextResponse.json({ errors }, { status: 400 });
    }

    // Import topics and comments
    let importedCount = 0;
    let updatedCount = 0;

    for (const parsedTopic of parsedTopics) {
      // Check if topic exists
      const existing = await db.select().from(topics)
        .where(and(eq(topics.id, parsedTopic.id), eq(topics.project_id, projectId)))
        .limit(1);

      if (existing.length > 0) {
        // Update existing topic
        await db.update(topics)
          .set({
            topic: parsedTopic.topic,
            description: parsedTopic.description,
            status: parsedTopic.status,
            priority: parsedTopic.priority,
            category: parsedTopic.category,
            date_updated: parsedTopic.date_updated,
            updated_at: new Date()
          })
          .where(eq(topics.id, parsedTopic.id));

        updatedCount++;
      } else {
        // Insert new topic
        await db.insert(topics).values({
          id: parsedTopic.id,
          project_id: projectId,
          topic: parsedTopic.topic,
          description: parsedTopic.description,
          status: parsedTopic.status,
          priority: parsedTopic.priority,
          category: parsedTopic.category,
          date_created: parsedTopic.date_created,
          date_updated: parsedTopic.date_updated
        });

        importedCount++;
      }

      // Delete existing comments for this topic
      await db.delete(comments).where(eq(comments.topic_id, parsedTopic.id));

      // Insert comments
      for (const comment of parsedTopic.comments) {
        await db.insert(comments).values({
          id: `comment_${nanoid(12)}`,
          topic_id: parsedTopic.id,
          author: comment.author,
          content: comment.content,
          comment_round: comment.round,
          created_at: comment.timestamp
        });
      }

      // Add category if not exists
      if (parsedTopic.category && parsedTopic.category !== 'Uncategorized') {
        const existingCat = await db.select().from(categories)
          .where(and(eq(categories.project_id, projectId), eq(categories.name, parsedTopic.category)))
          .limit(1);

        if (existingCat.length === 0) {
          await db.insert(categories).values({
            id: `category_${nanoid(12)}`,
            project_id: projectId,
            name: parsedTopic.category,
            is_suggested: false
          });
        }
      }
    }

    return NextResponse.json({
      success: true,
      imported: importedCount,
      updated: updatedCount,
      total: parsedTopics.length
    });

  } catch (error) {
    console.error('Import error:', error);
    return NextResponse.json({ error: 'Import failed' }, { status: 500 });
  }
}
```

### 8.4 Export Handler (app/api/export/route.ts)

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { exportCSV } from '@/lib/csv/exporter';
import { db } from '@/lib/db/client';
import { topics, comments, projects } from '@/lib/db/schema';
import { eq } from 'drizzle-orm';
import fs from 'fs/promises';
import path from 'path';

export async function POST(request: NextRequest) {
  try {
    const { projectId } = await request.json();

    if (!projectId) {
      return NextResponse.json({ error: 'Missing projectId' }, { status: 400 });
    }

    // Fetch project
    const project = await db.select().from(projects).where(eq(projects.id, projectId)).limit(1);
    if (project.length === 0) {
      return NextResponse.json({ error: 'Project not found' }, { status: 404 });
    }

    const csvPath = project[0].csv_file_path;

    // Fetch all topics with comments
    const topicsData = await db.select().from(topics).where(eq(topics.project_id, projectId));

    const exportTopics = [];
    for (const topic of topicsData) {
      const topicComments = await db.select().from(comments)
        .where(eq(comments.topic_id, topic.id))
        .orderBy(comments.comment_round, comments.created_at);

      exportTopics.push({
        ...topic,
        comments: topicComments.map(c => ({
          author: c.author as 'user' | 'claude',
          content: c.content,
          round: c.comment_round,
          timestamp: new Date(c.created_at)
        }))
      });
    }

    // Generate CSV content
    const instructions = `CRITICAL RULES FOR AI: (1) NEVER overwrite existing comment columns - ALWAYS add a NEW column to the right. (2) Name new columns sequentially: Your_Comments, Claude_Comments, Your_Comments_2, Claude_Comments_2, etc. (3) Prefix each comment with timestamp: 'YYYY-MM-DD HH:MM: ' (4) Update Date_Updated column (Column H) to current date when modifying any row. (5) Update Status column (Column D) to Resolved when answering. (6) Fixed columns A-H are: ID, Topic, Description, Status, Priority, Category, Date_Created, Date_Updated. (7) Parser identifies columns by NAME not position - column order can vary. (8) ID column uses UUIDs (format: topic_abc123). (9) This CSV file is the TEMPLATE - use exact structure when creating exports.`;

    const csvContent = exportCSV(exportTopics, instructions);

    // Create backup
    const backupDir = path.join(path.dirname(csvPath), '.backups');
    await fs.mkdir(backupDir, { recursive: true });

    const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
    const backupPath = path.join(backupDir, `${path.basename(csvPath, '.csv')}_backup_${timestamp}.csv`);

    // Read existing file if exists
    try {
      const existingContent = await fs.readFile(csvPath, 'utf-8');
      await fs.writeFile(backupPath, existingContent);
    } catch (err) {
      // File doesn't exist yet, skip backup
    }

    // Write new CSV
    await fs.writeFile(csvPath, csvContent, 'utf-8');

    // Cleanup old backups (keep last 10)
    const backups = await fs.readdir(backupDir);
    const sortedBackups = backups
      .filter(f => f.startsWith(path.basename(csvPath, '.csv')))
      .sort()
      .reverse();

    for (let i = 10; i < sortedBackups.length; i++) {
      await fs.unlink(path.join(backupDir, sortedBackups[i]));
    }

    return NextResponse.json({
      success: true,
      path: csvPath,
      backup: backupPath
    });

  } catch (error) {
    console.error('Export error:', error);
    return NextResponse.json({ error: 'Export failed' }, { status: 500 });
  }
}
```

### 8.5 File Watcher (lib/file-watcher.ts)

```typescript
import chokidar from 'chokidar';

interface FileWatcherOptions {
  interval: number; // milliseconds
  enabled: boolean;
  onFileChange: (filePath: string) => void;
}

export class FileWatcher {
  private watcher: chokidar.FSWatcher | null = null;
  private options: FileWatcherOptions;
  private lastModTime: Map<string, number> = new Map();

  constructor(options: FileWatcherOptions) {
    this.options = options;
  }

  watch(filePath: string) {
    if (!this.options.enabled) return;

    this.watcher = chokidar.watch(filePath, {
      ignoreInitial: true,
      awaitWriteFinish: {
        stabilityThreshold: 500,
        pollInterval: 100
      }
    });

    this.watcher.on('change', (path) => {
      const stats = require('fs').statSync(path);
      const modTime = stats.mtimeMs;

      const lastMod = this.lastModTime.get(path);
      if (!lastMod || modTime > lastMod) {
        this.lastModTime.set(path, modTime);
        this.options.onFileChange(path);
      }
    });
  }

  unwatch() {
    if (this.watcher) {
      this.watcher.close();
      this.watcher = null;
    }
  }

  updateOptions(options: Partial<FileWatcherOptions>) {
    this.options = { ...this.options, ...options };
  }
}
```

**Usage in Client:**
```typescript
// In project page component
useEffect(() => {
  const watcher = new FileWatcher({
    interval: settings.fileWatchInterval,
    enabled: settings.fileWatchEnabled,
    onFileChange: (filePath) => {
      toast({
        title: 'CSV file updated',
        description: 'Click to import changes',
        action: <Button onClick={() => handleImport()}>Import</Button>
      });
    }
  });

  if (currentProject?.csv_file_path) {
    watcher.watch(currentProject.csv_file_path);
  }

  return () => watcher.unwatch();
}, [currentProject, settings]);
```

---

## 9. Error Handling & Validation

### 9.1 CSV Import Validation

**Required Columns Check:**
```typescript
const requiredColumns = ['ID', 'Topic', 'Description', 'Status'];
const missingColumns = requiredColumns.filter(col => !headers.includes(col));

if (missingColumns.length > 0) {
  throw new Error(`Missing required columns: ${missingColumns.join(', ')}\nFound: ${headers.join(', ')}`);
}
```

**Status Validation:**
```typescript
const validStatuses = ['Open', 'In Progress', 'Resolved', 'Closed'];
if (!validStatuses.includes(topic.status)) {
  console.warn(`Invalid status "${topic.status}" for topic ${topic.id}. Defaulting to "Open".`);
  topic.status = 'Open';
}
```

**Priority Validation:**
```typescript
const validPriorities = ['High', 'Medium', 'Low'];
if (!validPriorities.includes(topic.priority)) {
  console.warn(`Invalid priority "${topic.priority}" for topic ${topic.id}. Defaulting to "Medium".`);
  topic.priority = 'Medium';
}
```

**UUID Validation:**
```typescript
if (!topic.id || topic.id === '') {
  topic.id = `topic_${nanoid(12)}`;
  console.warn(`Topic missing ID. Generated: ${topic.id}`);
}

if (!topic.id.startsWith('topic_')) {
  console.warn(`Topic ID "${topic.id}" doesn't follow convention (topic_xxx). This may cause sync issues.`);
}
```

### 9.2 Export Validation

**Pre-export Checks:**
```typescript
// Check if CSV file path is accessible
try {
  await fs.access(csvPath, fs.constants.W_OK);
} catch (err) {
  throw new Error(`Cannot write to CSV file: ${csvPath}. Check permissions.`);
}

// Check if backup directory can be created
const backupDir = path.join(path.dirname(csvPath), '.backups');
try {
  await fs.mkdir(backupDir, { recursive: true });
} catch (err) {
  console.warn(`Could not create backup directory. Proceeding without backup.`);
}
```

### 9.3 User Input Validation

**New Topic Form:**
```typescript
const validateTopicForm = (data: any) => {
  const errors: string[] = [];

  if (!data.topic || data.topic.trim() === '') {
    errors.push('Topic title is required');
  }

  if (data.topic && data.topic.length > 200) {
    errors.push('Topic title must be less than 200 characters');
  }

  if (!data.status || !['Open', 'In Progress', 'Resolved', 'Closed'].includes(data.status)) {
    errors.push('Invalid status');
  }

  if (!data.priority || !['High', 'Medium', 'Low'].includes(data.priority)) {
    errors.push('Invalid priority');
  }

  return errors;
};
```

**Comment Validation:**
```typescript
const validateComment = (content: string) => {
  if (!content || content.trim() === '') {
    return 'Comment cannot be empty';
  }

  if (content.length > 10000) {
    return 'Comment is too long (max 10,000 characters)';
  }

  return null;
};
```

---

## 10. Settings & Configuration

### 10.1 Settings Schema

```typescript
interface AppSettings {
  // File Watching
  fileWatchEnabled: boolean;
  fileWatchInterval: number; // 10000, 30000, 60000 (ms)

  // Export
  backupRetentionCount: number; // default: 10
  autoExportOnTopicCreate: boolean; // default: true

  // UI
  defaultView: 'conversation' | 'table' | 'board' | 'timeline' | 'analytics';
  darkMode: boolean; // default: true

  // Search
  searchDebounceMs: number; // default: 300

  // Categories
  defaultCategories: string[]; // ['Technical', 'UX', 'Database', 'Backend', 'Frontend', 'Planning']
}
```

### 10.2 Default Settings

```typescript
export const DEFAULT_SETTINGS: AppSettings = {
  fileWatchEnabled: true,
  fileWatchInterval: 30000, // 30 seconds
  backupRetentionCount: 10,
  autoExportOnTopicCreate: true,
  defaultView: 'conversation',
  darkMode: true,
  searchDebounceMs: 300,
  defaultCategories: ['Technical', 'UX', 'Database', 'Backend', 'Frontend', 'Planning']
};
```

### 10.3 Settings Storage

Store in local storage (browser) or config file (Electron):

```typescript
export const saveSettings = (settings: AppSettings) => {
  localStorage.setItem('exelentthreads_settings', JSON.stringify(settings));
};

export const loadSettings = (): AppSettings => {
  const saved = localStorage.getItem('exelentthreads_settings');
  return saved ? { ...DEFAULT_SETTINGS, ...JSON.parse(saved) } : DEFAULT_SETTINGS;
};
```

### 10.4 Settings Modal UI

```html
<div class="settings-modal">
  <h2>Settings</h2>

  <section class="settings-section">
    <h3>File Watching</h3>
    <label>
      <input type="checkbox" checked={fileWatchEnabled} />
      Enable automatic file watching
    </label>
    <label>
      Check interval:
      <select value={fileWatchInterval}>
        <option value="10000">10 seconds</option>
        <option value="30000">30 seconds</option>
        <option value="60000">60 seconds</option>
      </select>
    </label>
  </section>

  <section class="settings-section">
    <h3>Export</h3>
    <label>
      Keep last
      <input type="number" value={backupRetentionCount} min="1" max="50" />
      backups
    </label>
    <label>
      <input type="checkbox" checked={autoExportOnTopicCreate} />
      Auto-export when creating new topic
    </label>
  </section>

  <section class="settings-section">
    <h3>Default Categories</h3>
    <div class="category-tags">
      {#each defaultCategories as category}
        <span class="category-tag">
          {category}
          <button class="remove-category">Ã—</button>
        </span>
      {/each}
    </div>
    <button class="btn-add-category">+ Add Category</button>
  </section>

  <div class="settings-actions">
    <button class="btn btn-secondary" onClick={resetToDefaults}>
      Reset to Defaults
    </button>
    <button class="btn btn-primary" onClick={saveSettings}>
      Save
    </button>
  </div>
</div>
```

---

## 11. Topic Detail Modal

### 11.1 Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [âœ• Close]                                          â”‚
â”‚                                                      â”‚
â”‚  ğŸ”’ API Authentication Strategy         [Resolved â–¼]â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                      â”‚
â”‚  Description:                                       â”‚
â”‚  Need to decide between JWT and session-based       â”‚
â”‚  authentication for the API endpoints. Consider     â”‚
â”‚  security, scalability, and team familiarity.       â”‚
â”‚                                                      â”‚
â”‚  ğŸ“ Security | â¬†ï¸ High | ğŸ“… Created: Nov 3, 2025    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                      â”‚
â”‚  ğŸ’¬ Conversation Thread:                            â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ‘¤ Your Comment (Nov 3, 2025 10:30)            â”‚ â”‚
â”‚  â”‚ What are the pros and cons of JWT vs session?  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ¤– Claude's Response (Nov 3, 2025 10:35)       â”‚ â”‚
â”‚  â”‚ JWT pros: Stateless, scalable...               â”‚ â”‚
â”‚  â”‚ Session pros: Revocable, simpler...            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ‘¤ Your Comment (Nov 4, 2025 14:20)            â”‚ â”‚
â”‚  â”‚ Let's go with JWT for our use case.            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                      â”‚
â”‚  [Add Your Comment]                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Type your comment here...                      â”‚ â”‚
â”‚  â”‚                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [Post Comment]                                     â”‚
â”‚                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  [Delete Topic] [Save & Export]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 Features

**Editable Fields:**
- Topic title (if not locked)
- Description (if not locked)
- Status (dropdown)
- Priority (dropdown - select, not shown)
- Category (text input with autocomplete)

**Locked Fields:**
- Topic and Description show ğŸ”’ icon if `is_locked = 1`
- Hover tooltip: "Locked after first export to prevent sync issues"

**Comment Thread:**
- Display all comments chronologically
- User comments: right-aligned, light background, ğŸ‘¤ icon
- Claude comments: left-aligned, dark background, ğŸ¤– icon
- Show timestamp for each comment

**Add Comment:**
- Textarea for new comment
- "Post Comment" button
- On post:
  - Insert into database
  - Do NOT auto-export (user must click "Save & Export")
  - Show success toast: "Comment added"

**Actions:**
- Delete Topic: confirm dialog, delete from DB
- Save & Export: save changes, trigger export flow
- Close (Ã—): discard unsaved changes (confirm if dirty)

### 11.3 Implementation

```tsx
'use client';

import { useState } from 'react';
import { formatDate } from '@/lib/utils/date';

interface TopicModalProps {
  topic: any;
  onClose: () => void;
  onSave: (topic: any) => void;
  onDelete: (topicId: string) => void;
}

export function TopicModal({ topic, onClose, onSave, onDelete }: TopicModalProps) {
  const [editedTopic, setEditedTopic] = useState(topic);
  const [newComment, setNewComment] = useState('');

  const handlePostComment = async () => {
    if (!newComment.trim()) return;

    // Add comment to database
    await fetch('/api/comments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        topic_id: topic.id,
        author: 'user',
        content: newComment,
        comment_round: topic.comments.length / 2 + 1 // Calculate next round
      })
    });

    // Refresh topic data
    setNewComment('');
    // TODO: Reload comments from DB
  };

  const handleSaveAndExport = async () => {
    await onSave(editedTopic);
    // Trigger export
    await fetch('/api/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ projectId: topic.project_id })
    });
    onClose();
  };

  return (
    <div className="topic-modal">
      <div className="topic-modal-backdrop" onClick={onClose} />
      <div className="topic-modal-content">
        {/* Header */}
        <div className="topic-modal-header">
          <input
            type="text"
            value={editedTopic.topic}
            onChange={(e) => setEditedTopic({ ...editedTopic, topic: e.target.value })}
            disabled={topic.is_locked}
            className="topic-modal-title-input"
          />
          {topic.is_locked && <span title="Locked after first export">ğŸ”’</span>}

          <select
            value={editedTopic.status}
            onChange={(e) => setEditedTopic({ ...editedTopic, status: e.target.value })}
            className="topic-modal-status-select"
          >
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>

          <button onClick={onClose} className="topic-modal-close">âœ•</button>
        </div>

        {/* Description */}
        <div className="topic-modal-body">
          <label>Description:</label>
          <textarea
            value={editedTopic.description}
            onChange={(e) => setEditedTopic({ ...editedTopic, description: e.target.value })}
            disabled={topic.is_locked}
            className="topic-modal-description"
          />

          {/* Meta */}
          <div className="topic-modal-meta">
            <span>ğŸ“ {topic.category}</span>
            <span>ğŸ“… Created: {formatDate(topic.date_created)}</span>
            <span>ğŸ“… Updated: {formatDate(topic.date_updated)}</span>
          </div>

          {/* Comment Thread */}
          <h3>ğŸ’¬ Conversation Thread</h3>
          <div className="comment-thread">
            {topic.comments.map((comment: any) => (
              <div key={comment.id} className={`comment ${comment.author}`}>
                <div className="comment-header">
                  <span className="comment-author">
                    {comment.author === 'user' ? 'ğŸ‘¤ You' : 'ğŸ¤– Claude'}
                  </span>
                  <span className="comment-timestamp">
                    {formatDate(comment.created_at)}
                  </span>
                </div>
                <div className="comment-content">{comment.content}</div>
              </div>
            ))}
          </div>

          {/* Add Comment */}
          <div className="add-comment">
            <label>Add Your Comment</label>
            <textarea
              value={newComment}
              onChange={(e) => setNewComment(e.target.value)}
              placeholder="Type your comment here..."
              className="add-comment-textarea"
            />
            <button onClick={handlePostComment} className="btn btn-secondary">
              Post Comment
            </button>
          </div>
        </div>

        {/* Footer Actions */}
        <div className="topic-modal-footer">
          <button onClick={() => onDelete(topic.id)} className="btn btn-danger">
            Delete Topic
          </button>
          <button onClick={handleSaveAndExport} className="btn btn-primary">
            Save & Export
          </button>
        </div>
      </div>
    </div>
  );
}
```

---

## 12. New Topic Creation

### 12.1 New Topic Modal

```html
<div class="new-topic-modal">
  <h2>Create New Topic</h2>

  <form onSubmit={handleCreateTopic}>
    <label>
      Topic Title *
      <input type="text" name="topic" placeholder="E.g., API Error Handling" required />
    </label>

    <label>
      Description
      <textarea name="description" placeholder="Describe the topic or question..." rows="4"></textarea>
    </label>

    <label>
      Status
      <select name="status">
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Resolved">Resolved</option>
        <option value="Closed">Closed</option>
      </select>
    </label>

    <label>
      Priority
      <select name="priority">
        <option value="High">High</option>
        <option value="Medium" selected>Medium</option>
        <option value="Low">Low</option>
      </select>
    </label>

    <label>
      Category
      <input type="text" name="category" list="category-suggestions" placeholder="E.g., Technical" />
      <datalist id="category-suggestions">
        <option value="Technical" />
        <option value="UX" />
        <option value="Database" />
        <option value="Backend" />
        <option value="Frontend" />
        <option value="Planning" />
      </datalist>
    </label>

    <label>
      Initial Comment (Optional)
      <textarea name="initialComment" placeholder="Add your first comment or question..." rows="3"></textarea>
    </label>

    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" onClick={onClose}>
        Cancel
      </button>
      <button type="submit" class="btn btn-primary">
        Create Topic
      </button>
    </div>
  </form>
</div>
```

### 12.2 Creation Flow

```
User clicks "+ New Topic" button
  â†“
Modal opens with form
  â†“
User fills form and submits
  â†“
1. Generate UUID for topic: topic_abc123
2. Set date_created and date_updated to current date
3. INSERT topic into database
4. If initialComment provided:
   - Generate UUID for comment: comment_xyz789
   - Set author = 'user'
   - Set comment_round = 1
   - Set created_at = current timestamp
   - INSERT comment into database
5. If autoExportOnTopicCreate = true:
   - Trigger export flow
   - Show toast: "Topic created and exported"
6. Else:
   - Show toast: "Topic created. Remember to export!"
7. Close modal
8. Refresh topics list
9. Optionally: Open topic detail modal for new topic
```

---

## 13. Search & Filter Implementation

### 13.1 Global Search

**Search Query Processing:**
```typescript
export function searchTopics(topics: any[], query: string): any[] {
  if (!query || query.trim() === '') return topics;

  const lowerQuery = query.toLowerCase();
  const words = lowerQuery.split(/\s+/);

  return topics.filter(topic => {
    const searchableText = [
      topic.topic,
      topic.description,
      topic.category,
      ...topic.comments.map((c: any) => c.content)
    ].join(' ').toLowerCase();

    // Match if ALL words found (AND logic)
    return words.every(word => searchableText.includes(word));
  });
}
```

**Fuzzy Search (Optional Enhancement):**
```typescript
import Fuse from 'fuse.js';

export function fuzzySearchTopics(topics: any[], query: string): any[] {
  const fuse = new Fuse(topics, {
    keys: ['topic', 'description', 'category', 'comments.content'],
    threshold: 0.4, // 0 = exact match, 1 = match anything
    includeScore: true
  });

  const results = fuse.search(query);
  return results.map(r => r.item);
}
```

**Real-time Search with Debounce:**
```tsx
'use client';

import { useState, useEffect } from 'react';
import { useDebouncedCallback } from 'use-debounce';

export function GlobalSearch({ topics, onSearchResults }: any) {
  const [query, setQuery] = useState('');

  const debouncedSearch = useDebouncedCallback((value: string) => {
    const results = searchTopics(topics, value);
    onSearchResults(results);
  }, 300);

  useEffect(() => {
    debouncedSearch(query);
  }, [query]);

  return (
    <input
      type="text"
      value={query}
      onChange={(e) => setQuery(e.target.value)}
      placeholder="ğŸ” Search topics..."
      className="global-search-input"
    />
  );
}
```

### 13.2 Filter Dropdowns

**Filter State:**
```typescript
interface Filters {
  status: string[]; // ['Open', 'Resolved']
  priority: string[]; // ['High']
  category: string[]; // ['Technical', 'UX']
}
```

**Filter Application:**
```typescript
export function applyFilters(topics: any[], filters: Filters): any[] {
  return topics.filter(topic => {
    // Status filter (OR logic)
    if (filters.status.length > 0 && !filters.status.includes(topic.status)) {
      return false;
    }

    // Priority filter (OR logic)
    if (filters.priority.length > 0 && !filters.priority.includes(topic.priority)) {
      return false;
    }

    // Category filter (OR logic)
    if (filters.category.length > 0 && !filters.category.includes(topic.category)) {
      return false;
    }

    return true;
  });
}
```

**Filter UI:**
```tsx
export function FilterDropdown({ label, options, selected, onChange }: any) {
  return (
    <div className="filter-dropdown">
      <label>{label}</label>
      <div className="filter-options">
        {options.map((option: string) => (
          <label key={option} className="filter-option">
            <input
              type="checkbox"
              checked={selected.includes(option)}
              onChange={(e) => {
                if (e.target.checked) {
                  onChange([...selected, option]);
                } else {
                  onChange(selected.filter((s: string) => s !== option));
                }
              }}
            />
            {option}
          </label>
        ))}
      </div>
    </div>
  );
}
```

---

## 14. Multi-Project Management

### 14.1 Projects List Sidebar

**Render Projects:**
```tsx
<div className="sidebar-project-selector">
  <label>Current Project</label>
  <div className="project-dropdown">
    <button id="project-selector-btn">
      <span className="project-color-dot" style={{ background: currentProject.color }} />
      <span>{currentProject.name}</span>
      <span className="topic-count">({currentProject.topicCount} topics)</span>
      <span>â–¼</span>
    </button>
    <div className="project-dropdown-menu hidden">
      {projects.map(project => (
        <div
          key={project.id}
          className="project-dropdown-item"
          onClick={() => switchProject(project.id)}
        >
          <span className="project-color-dot" style={{ background: project.color }} />
          <span>{project.name}</span>
          <span className="project-topic-count">{project.topicCount}</span>
        </div>
      ))}
      <div className="project-dropdown-divider" />
      <button onClick={openManageProjects}>
        ğŸ“ Manage Projects
      </button>
    </div>
  </div>
</div>
```

### 14.2 Manage Projects Modal

```html
<div class="manage-projects-modal">
  <h2>Manage Projects</h2>

  <div class="projects-list">
    {#each projects as project}
    <div class="project-item">
      <input type="color" value={project.color} onChange={updateColor(project.id)} />
      <input type="text" value={project.name} onChange={updateName(project.id)} />
      <span>{project.topicCount} topics</span>
      <button onClick={deleteProject(project.id)}>Delete</button>
    </div>
    {/each}
  </div>

  <button class="btn btn-primary" onClick={openNewProjectForm}>
    + New Project
  </button>
</div>
```

### 14.3 Create New Project Flow

```
User clicks "+ New Project"
  â†“
Modal opens with form:
  - Project Name (text input)
  - CSV File Path (file picker)
  - Color (color picker, default: #2563eb)
  â†“
User submits
  â†“
1. Validate:
   - Name not empty
   - CSV file path is valid and writable
2. Generate project UUID: project_abc123
3. INSERT into projects table
4. Seed default categories for project
5. Show success toast
6. Switch to new project
7. Show "Import CSV" prompt
```

**Create Project API:**
```typescript
export async function POST(request: NextRequest) {
  const { name, csvFilePath, color } = await request.json();

  // Validate
  if (!name || !csvFilePath) {
    return NextResponse.json({ error: 'Missing name or csvFilePath' }, { status: 400 });
  }

  // Check if file is writable
  try {
    await fs.access(csvFilePath, fs.constants.W_OK);
  } catch (err) {
    return NextResponse.json({ error: 'CSV file path is not writable' }, { status: 400 });
  }

  // Create project
  const projectId = `project_${nanoid(12)}`;
  await db.insert(projects).values({
    id: projectId,
    name,
    csv_file_path: csvFilePath,
    color: color || '#2563eb',
    created_at: new Date(),
    updated_at: new Date()
  });

  // Seed default categories
  const defaultCategories = ['Technical', 'UX', 'Database', 'Backend', 'Frontend', 'Planning'];
  for (const cat of defaultCategories) {
    await db.insert(categories).values({
      id: `category_${nanoid(12)}`,
      project_id: projectId,
      name: cat,
      is_suggested: true
    });
  }

  return NextResponse.json({ success: true, projectId });
}
```

---

## 15. Deployment Considerations

### 15.1 Local Development

```bash
npm install
npm run dev
```

**Database Setup:**
```bash
# Generate migrations
npx drizzle-kit generate:sqlite

# Run migrations
npx drizzle-kit push:sqlite
```

**Environment Variables:**
```env
DATABASE_URL=file:./exelentthreads.db
NODE_ENV=development
```

### 15.2 Production Build

```bash
npm run build
npm run start
```

**For Desktop App (Optional):**
Use Electron Forge or similar to package Next.js app as desktop application.

### 15.3 Data Persistence

**SQLite Database Location:**
- Development: `./exelentthreads.db` in project root
- Production (desktop): User data directory (e.g., `~/.exelentthreads/exelentthreads.db`)

**CSV Files Location:**
- User-specified paths (stored in projects.csv_file_path)
- Backups: `.backups/` folder next to CSV file

---

## 16. Testing Strategy

### 16.1 Unit Tests

**CSV Parser Tests:**
```typescript
describe('parseCSV', () => {
  it('should parse valid CSV with all columns', () => {
    const csv = `...`;
    const result = parseCSV(csv);
    expect(result.topics).toHaveLength(5);
    expect(result.errors).toHaveLength(0);
  });

  it('should handle missing optional columns', () => {
    const csv = `ID,Topic,Description,Status\n1,Test,Desc,Open`;
    const result = parseCSV(csv);
    expect(result.topics[0].priority).toBe('Medium');
  });

  it('should extract comment timestamps', () => {
    const csv = `...`;
    const result = parseCSV(csv);
    expect(result.topics[0].comments[0].timestamp).toBeInstanceOf(Date);
  });

  it('should reject CSV with missing required columns', () => {
    const csv = `ID,Topic\n1,Test`;
    const result = parseCSV(csv);
    expect(result.errors).toContain('Missing required column: Description');
  });
});
```

**CSV Exporter Tests:**
```typescript
describe('exportCSV', () => {
  it('should generate CSV with correct column order', () => {
    const topics = [...];
    const csv = exportCSV(topics, 'Instructions...');
    const lines = csv.split('\n');
    expect(lines[0]).toBe('ID,Topic,Description,Status,Priority,Category,Date_Created,Date_Updated,Your_Comments,Claude_Comments');
  });

  it('should include instructions row', () => {
    const csv = exportCSV([], 'Test instructions');
    expect(csv).toContain('INST,[INSTRUCTIONS FOR CLAUDE],"Test instructions"');
  });

  it('should format comment timestamps', () => {
    const topics = [{
      id: 'topic_1',
      comments: [{
        author: 'user',
        content: 'Test',
        round: 1,
        timestamp: new Date('2025-11-05T14:30:00')
      }]
    }];
    const csv = exportCSV(topics, '');
    expect(csv).toContain('2025-11-05 14:30: Test');
  });
});
```

### 16.2 Integration Tests

**Import Flow Test:**
```typescript
describe('Import Flow', () => {
  it('should import CSV and create topics in database', async () => {
    const csvContent = `...`;
    const response = await fetch('/api/import', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();
    expect(result.imported).toBe(5);

    const topics = await db.select().from(topics).where(eq(topics.project_id, projectId));
    expect(topics).toHaveLength(5);
  });
});
```

**Export Flow Test:**
```typescript
describe('Export Flow', () => {
  it('should export topics to CSV file', async () => {
    // Setup: Create topics in DB
    await db.insert(topics).values([...]);

    const response = await fetch('/api/export', {
      method: 'POST',
      body: JSON.stringify({ projectId })
    });

    const result = await response.json();
    expect(result.success).toBe(true);

    // Verify CSV file was created
    const csvContent = await fs.readFile(result.path, 'utf-8');
    expect(csvContent).toContain('ID,Topic,Description');
  });

  it('should create backup file', async () => {
    // ... test backup creation
  });
});
```

### 16.3 E2E Tests (Optional)

Use Playwright or Cypress for end-to-end testing:

```typescript
test('Create new topic and export', async ({ page }) => {
  await page.goto('/projects/project_123');
  await page.click('#new-topic-btn');
  await page.fill('input[name="topic"]', 'Test Topic');
  await page.fill('textarea[name="description"]', 'Test Description');
  await page.click('button[type="submit"]');

  await page.waitForSelector('.toast:has-text("Topic created")');

  await page.click('#export-csv-btn');
  await page.waitForSelector('.toast:has-text("Exported")');

  // Verify CSV file exists
  const csvPath = await page.evaluate(() => localStorage.getItem('last_export_path'));
  expect(csvPath).toBeTruthy();
});
```

---

## 17. Performance Considerations

### 17.1 Database Indexing

All critical indexes are defined in schema (see section 3.2). Ensure migrations create these indexes.

### 17.2 Large CSV Files

For CSV files with 1000+ topics:
- Use streaming parser: `papaparse` with `step` callback
- Batch database inserts (insert 100 topics at a time)
- Show progress indicator during import

```typescript
const parseStream = (fileContent: string, onProgress: (percent: number) => void) => {
  let rowCount = 0;
  const topics: any[] = [];

  Papa.parse(fileContent, {
    header: true,
    step: (row) => {
      rowCount++;
      topics.push(processRow(row.data));

      if (rowCount % 100 === 0) {
        onProgress((rowCount / estimatedTotal) * 100);
      }
    },
    complete: async () => {
      // Batch insert
      for (let i = 0; i < topics.length; i += 100) {
        const batch = topics.slice(i, i + 100);
        await db.insert(topics).values(batch);
      }
    }
  });
};
```

### 17.3 Search Performance

For projects with 1000+ topics:
- Implement full-text search using SQLite FTS5:

```sql
CREATE VIRTUAL TABLE topics_fts USING fts5(
  topic,
  description,
  content='topics',
  content_rowid='id'
);

-- Populate FTS table
INSERT INTO topics_fts(rowid, topic, description)
SELECT id, topic, description FROM topics;
```

Query:
```typescript
const searchResults = await db.select().from(topics_fts)
  .where(sql`topics_fts MATCH ${query}`)
  .limit(50);
```

### 17.4 File Watching Optimization

- Use debouncing (already implemented)
- Only watch active project's CSV file
- Unwatch when switching projects or app backgrounded

---

## 18. Security Considerations

### 18.1 File Path Validation

**Prevent Path Traversal:**
```typescript
import path from 'path';

export function validateFilePath(filePath: string): boolean {
  const normalized = path.normalize(filePath);

  // Prevent access to system directories
  const forbiddenPaths = ['/etc', '/sys', '/proc', 'C:\\Windows', 'C:\\System32'];
  for (const forbidden of forbiddenPaths) {
    if (normalized.startsWith(forbidden)) {
      return false;
    }
  }

  // Must be absolute path
  if (!path.isAbsolute(normalized)) {
    return false;
  }

  return true;
}
```

### 18.2 Input Sanitization

**Prevent XSS in Comments:**
```typescript
import DOMPurify from 'dompurify';

export function sanitizeComment(content: string): string {
  return DOMPurify.sanitize(content, {
    ALLOWED_TAGS: [], // No HTML allowed
    ALLOWED_ATTR: []
  });
}
```

**Or use plain text rendering:**
```tsx
<div className="comment-content">
  {comment.content} {/* React automatically escapes text */}
</div>
```

### 18.3 SQL Injection Prevention

**Use Parameterized Queries (Drizzle ORM handles this):**
```typescript
// âœ… SAFE - Drizzle parameterizes automatically
await db.select().from(topics).where(eq(topics.id, userInput));

// âŒ UNSAFE - Never do this
await db.execute(sql`SELECT * FROM topics WHERE id = '${userInput}'`);
```

---

## 19. Accessibility (a11y)

### 19.1 Keyboard Navigation

**Modal Focus Trap:**
```typescript
useEffect(() => {
  const modal = document.getElementById('topic-modal');
  const focusableElements = modal.querySelectorAll(
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );

  const firstElement = focusableElements[0];
  const lastElement = focusableElements[focusableElements.length - 1];

  const handleTabKey = (e: KeyboardEvent) => {
    if (e.key === 'Tab') {
      if (e.shiftKey && document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      } else if (!e.shiftKey && document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    }
  };

  modal.addEventListener('keydown', handleTabKey);
  return () => modal.removeEventListener('keydown', handleTabKey);
}, []);
```

**Escape Key to Close Modals:**
```typescript
useEffect(() => {
  const handleEscape = (e: KeyboardEvent) => {
    if (e.key === 'Escape') {
      onClose();
    }
  };

  document.addEventListener('keydown', handleEscape);
  return () => document.removeEventListener('keydown', handleEscape);
}, [onClose]);
```

### 19.2 ARIA Labels

```html
<!-- Search Input -->
<input
  type="text"
  id="global-search"
  placeholder="Search topics..."
  aria-label="Search topics"
  aria-describedby="search-help"
/>
<span id="search-help" class="sr-only">
  Type to search across topic titles, descriptions, and comments
</span>

<!-- Status Dropdown -->
<select
  aria-label="Topic status"
  value={status}
  onChange={handleStatusChange}
>
  <option value="Open">Open</option>
  <option value="In Progress">In Progress</option>
  <option value="Resolved">Resolved</option>
  <option value="Closed">Closed</option>
</select>

<!-- Topic Card -->
<div
  className="topic-card"
  role="article"
  aria-labelledby={`topic-title-${topic.id}`}
  aria-describedby={`topic-desc-${topic.id}`}
>
  <h3 id={`topic-title-${topic.id}`}>{topic.topic}</h3>
  <p id={`topic-desc-${topic.id}`}>{topic.description}</p>
</div>
```

### 19.3 Screen Reader Announcements

```typescript
// Announce toast notifications
const showToast = (message: string) => {
  const toast = document.createElement('div');
  toast.setAttribute('role', 'status');
  toast.setAttribute('aria-live', 'polite');
  toast.className = 'toast';
  toast.textContent = message;

  document.getElementById('toast-container').appendChild(toast);

  setTimeout(() => toast.remove(), 5000);
};
```

---

## 20. Future Enhancements (Phase 2+)

**Not in this spec, but documented for reference:**

1. **Integrated AI Chat** - Real-time Claude API integration
2. **Topic Auto-Extraction** - AI detects topics from conversation
3. **Document/Artifact Management** - ProseMirror editor with sections
4. **Collaboration** - Multi-user real-time editing
5. **Cloud Sync** - Turso for cross-device sync
6. **Mobile App** - React Native version
7. **API Webhooks** - Notify external systems on topic changes
8. **Custom Views** - User-defined view templates
9. **Export Formats** - Markdown, PDF, JSON exports
10. **Topic Relationships Graph** - Visualize related topics

---

## 21. References

**Mockups:**
- `index.html` - Current demo with all 5 views
- `mockup-v2.html` - Phase 2 chat-first layout (NOT for this phase)

**Planning Documents:**
- `Planning/csv-workflow-questions.csv` - Implementation decisions (24 resolved topics)
- `Planning/implementation-questions.csv` - Original planning (48 topics)
- `Planning/MVP_PLANNING.md` - Initial architecture proposal

**Example CSV Template:**
- `Planning/csv-workflow-questions.csv` - Reference structure

**Libraries:**
- Next.js: https://nextjs.org
- Drizzle ORM: https://orm.drizzle.team
- Tailwind CSS: https://tailwindcss.com
- papaparse: https://www.papaparse.com
- chokidar: https://github.com/paulmillr/chokidar
- nanoid: https://github.com/ai/nanoid
- recharts: https://recharts.org

---

**END OF SPECIFICATION**

This specification is comprehensive and self-contained. Any Claude Code instance should be able to implement the CSV Workflow MVP accurately using only this document.
